FROM pveleskopglc/chipstar:base

ENV DEBIAN_FRONTEND noninteractive

SHELL ["/bin/bash", "-ci"]

#////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#//                                                                                                                                        //
#//                                                      Begin chipStar latest layer                                                      //
#//                                                                                                                                        //
#////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
 
RUN pip install pyyaml

RUN sudo apt-get install vim-common -y # for xxd

ENV CHIP_BE=opencl
ENV CHIP_DEVICE_TYPE=cpu
ENV CHIP_LOGLEVEL=info

RUN module load oneapi/2024.1.0 && which icpx && git clone https://github.com/CHIP-SPV/chipStar.git && \
    cd chipStar && \
    git submodule update --init --recursive && \
    mkdir build && \
    cd build && \
    cmake .. -DCMAKE_BUILD_TYPE=Release -DCHIP_BUILD_HIPBLAS=ON && \
    make -j$(nproc) && \
    make -j $(nproc) build_tests && \
    sudo make install 


RUN /home/chipStarUser/chipStar/build/samples/0_MatrixMultiply/MatrixMultiply

#////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#//                                                                                                                                        //
#//                                                      End of chipStar latest layer                                                      //
#//                                                                                                                                        //
#////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    